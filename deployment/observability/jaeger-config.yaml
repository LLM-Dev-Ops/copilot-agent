---
# Jaeger All-in-One for development (use production setup for prod)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger
  namespace: observability
  labels:
    app: jaeger
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jaeger
  template:
    metadata:
      labels:
        app: jaeger
    spec:
      containers:
        - name: jaeger
          image: jaegertracing/all-in-one:1.51
          env:
            - name: COLLECTOR_ZIPKIN_HOST_PORT
              value: ":9411"
            - name: SPAN_STORAGE_TYPE
              value: elasticsearch
            - name: ES_SERVER_URLS
              value: http://elasticsearch.observability.svc.cluster.local:9200
            - name: ES_INDEX_PREFIX
              value: jaeger
            - name: ES_NUM_SHARDS
              value: "3"
            - name: ES_NUM_REPLICAS
              value: "2"
          ports:
            - containerPort: 5775
              protocol: UDP
              name: zk-compact-trft
            - containerPort: 6831
              protocol: UDP
              name: jg-compact-trft
            - containerPort: 6832
              protocol: UDP
              name: jg-binary-trft
            - containerPort: 5778
              protocol: TCP
              name: config-rest
            - containerPort: 16686
              protocol: TCP
              name: query
            - containerPort: 14250
              protocol: TCP
              name: grpc
            - containerPort: 14268
              protocol: TCP
              name: collector
            - containerPort: 14269
              protocol: TCP
              name: admin
            - containerPort: 9411
              protocol: TCP
              name: zipkin
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 2Gi

---
apiVersion: v1
kind: Service
metadata:
  name: jaeger-query
  namespace: observability
  labels:
    app: jaeger
spec:
  type: ClusterIP
  ports:
    - name: query
      port: 16686
      targetPort: 16686
  selector:
    app: jaeger

---
apiVersion: v1
kind: Service
metadata:
  name: jaeger-collector
  namespace: observability
  labels:
    app: jaeger
spec:
  type: ClusterIP
  ports:
    - name: grpc
      port: 14250
      targetPort: 14250
    - name: http
      port: 14268
      targetPort: 14268
    - name: zipkin
      port: 9411
      targetPort: 9411
  selector:
    app: jaeger

---
apiVersion: v1
kind: Service
metadata:
  name: jaeger-agent
  namespace: observability
  labels:
    app: jaeger
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: zk-compact-trft
      port: 5775
      protocol: UDP
      targetPort: 5775
    - name: jg-compact-trft
      port: 6831
      protocol: UDP
      targetPort: 6831
    - name: jg-binary-trft
      port: 6832
      protocol: UDP
      targetPort: 6832
    - name: config-rest
      port: 5778
      protocol: TCP
      targetPort: 5778
  selector:
    app: jaeger

---
# Production Jaeger Operator CRD
apiVersion: jaegertracing.io/v1
kind: Jaeger
metadata:
  name: jaeger-production
  namespace: observability
spec:
  strategy: production
  storage:
    type: elasticsearch
    options:
      es:
        server-urls: http://elasticsearch.observability.svc.cluster.local:9200
        index-prefix: jaeger
        num-shards: 3
        num-replicas: 2
    esIndexCleaner:
      enabled: true
      numberOfDays: 7
      schedule: "55 23 * * *"

  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - jaeger.llmdevops.io
    tls:
      - secretName: jaeger-tls-cert
        hosts:
          - jaeger.llmdevops.io

  collector:
    replicas: 3
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 4Gi
    autoscale:
      enabled: true
      minReplicas: 3
      maxReplicas: 10
      targetCPUUtilizationPercentage: 70

  query:
    replicas: 2
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 2Gi

  agent:
    strategy: DaemonSet
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

---
# Sampling configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: jaeger-sampling-config
  namespace: observability
data:
  sampling.json: |
    {
      "default_strategy": {
        "type": "probabilistic",
        "param": 0.1
      },
      "service_strategies": [
        {
          "service": "llm-copilot-agent",
          "type": "probabilistic",
          "param": 0.5
        },
        {
          "service": "llm-copilot-agent",
          "operation": "/api/critical/*",
          "type": "probabilistic",
          "param": 1.0
        }
      ]
    }
