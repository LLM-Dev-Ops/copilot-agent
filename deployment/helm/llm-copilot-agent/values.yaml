# ==============================================================================
# Default values for llm-copilot-agent Helm chart
# ==============================================================================

# Global settings
global:
  imageRegistry: ""
  imagePullSecrets: []
  storageClass: ""

# Image configuration
image:
  registry: ghcr.io
  repository: llm-devops/llm-copilot-agent
  tag: "1.0.0"
  pullPolicy: IfNotPresent
  pullSecrets: []

# Deployment configuration
replicaCount: 3

nameOverride: ""
fullnameOverride: ""

# Service Account
serviceAccount:
  create: true
  annotations: {}
  name: ""
  automountServiceAccountToken: true

# Pod annotations and labels
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9090"
  prometheus.io/path: "/metrics"

podLabels:
  app.kubernetes.io/part-of: llm-devops-ecosystem

# Security Context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1001
  runAsGroup: 1001
  fsGroup: 1001
  seccompProfile:
    type: RuntimeDefault

containerSecurityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1001
  capabilities:
    drop:
      - ALL

# Service configuration
service:
  type: ClusterIP
  port: 80
  targetPort: 3000
  metricsPort: 9090
  annotations: {}
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800

# Ingress configuration
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/rate-limit: "100"
  hosts:
    - host: api.llmdevops.io
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: llm-copilot-tls-cert
      hosts:
        - api.llmdevops.io

# Resource limits and requests
resources:
  requests:
    cpu: 500m
    memory: 512Mi
    ephemeral-storage: 1Gi
  limits:
    cpu: 2000m
    memory: 2Gi
    ephemeral-storage: 2Gi

# Autoscaling
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 20
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
        - type: Pods
          value: 2
          periodSeconds: 60
      selectPolicy: Min
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
        - type: Pods
          value: 4
          periodSeconds: 30
      selectPolicy: Max

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 2

# Vertical Pod Autoscaler
verticalPodAutoscaler:
  enabled: false
  updateMode: Auto

# Node selection
nodeSelector: {}

tolerations: []

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - llm-copilot-agent
          topologyKey: kubernetes.io/hostname

# Topology Spread Constraints
topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: DoNotSchedule
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: llm-copilot-agent

# Probes
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /ready
    port: http
  initialDelaySeconds: 20
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

startupProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 30

# Environment variables
env:
  NODE_ENV: production
  LOG_LEVEL: info
  PORT: "3000"
  METRICS_PORT: "9090"

# ConfigMap data
config:
  ENABLE_TEST_GENERATION: "true"
  ENABLE_OBSERVABILITY: "true"
  ENABLE_INCIDENT_MANAGEMENT: "true"
  ENABLE_WORKFLOW_ORCHESTRATION: "true"
  MAX_CONCURRENT_REQUESTS: "100"
  REQUEST_TIMEOUT_MS: "30000"
  RATE_LIMIT_REQUESTS_PER_MINUTE: "1000"

# Secrets (use external secret manager in production)
secrets: {}
  # DATABASE_URL: ""
  # REDIS_PASSWORD: ""
  # OPENAI_API_KEY: ""

# External Secrets
externalSecrets:
  enabled: false
  secretStore:
    name: aws-secrets-manager
    kind: SecretStore
  data: []
    # - secretKey: DATABASE_URL
    #   remoteRef:
    #     key: llm-copilot/database/url

# PostgreSQL configuration
postgresql:
  enabled: true
  auth:
    username: llm_user
    password: changeme
    database: llm_copilot
  primary:
    persistence:
      enabled: true
      size: 100Gi
      storageClass: fast-ssd
    resources:
      requests:
        cpu: 2000m
        memory: 4Gi
      limits:
        cpu: 4000m
        memory: 8Gi
  readReplicas:
    replicaCount: 2
    persistence:
      enabled: true
      size: 100Gi
    resources:
      requests:
        cpu: 1000m
        memory: 2Gi
      limits:
        cpu: 2000m
        memory: 4Gi
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

# Redis configuration
redis:
  enabled: true
  auth:
    enabled: true
    password: changeme
  master:
    persistence:
      enabled: true
      size: 50Gi
      storageClass: fast-ssd
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 4Gi
  replica:
    replicaCount: 2
    persistence:
      enabled: true
      size: 50Gi
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 2Gi
  sentinel:
    enabled: true
    quorum: 2
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

# Service Mesh (Istio)
istio:
  enabled: false
  virtualService:
    enabled: true
    gateways:
      - llm-copilot-gateway
    hosts:
      - api.llmdevops.io
  destinationRule:
    enabled: true
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 100
        http:
          http1MaxPendingRequests: 100
          http2MaxRequests: 100
      loadBalancer:
        consistentHash:
          httpCookie:
            name: llm-copilot-session
            ttl: 3600s
      outlierDetection:
        consecutiveErrors: 5
        interval: 30s
        baseEjectionTime: 30s
  peerAuthentication:
    enabled: true
    mode: STRICT

# Network Policies
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 3000
  egress:
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 80

# Monitoring
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s
  prometheusRule:
    enabled: true

# Init Containers
initContainers:
  - name: wait-for-database
    image: busybox:1.35
    command:
      - sh
      - -c
      - |
        until nc -z {{ include "llm-copilot-agent.postgresql.host" . }} 5432; do
          echo "Waiting for PostgreSQL..."
          sleep 2
        done
  - name: wait-for-redis
    image: busybox:1.35
    command:
      - sh
      - -c
      - |
        until nc -z {{ include "llm-copilot-agent.redis.host" . }} 6379; do
          echo "Waiting for Redis..."
          sleep 2
        done

# Extra volumes
extraVolumes:
  - name: tmp
    emptyDir: {}
  - name: cache
    emptyDir: {}

# Extra volume mounts
extraVolumeMounts:
  - name: tmp
    mountPath: /tmp
  - name: cache
    mountPath: /app/.cache

# Backup configuration
backup:
  enabled: false
  schedule: "0 2 * * *"
  retention: 30
  storageClass: standard
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Tests
tests:
  enabled: true
  image:
    repository: curlimages/curl
    tag: latest
